import { Bishop } from '../../../../../models/pieces/bishop';
import { Color } from '../../../../../models/pieces/color';
import { King } from '../../../../../models/pieces/king';
import { Knight } from '../../../../../models/pieces/knight';
import { Pawn } from '../../../../../models/pieces/pawn';
import { Point } from '../../../../../models/pieces/point';
import { Queen } from '../../../../../models/pieces/queen';
import { Rook } from '../../../../../models/pieces/rook';
import { MoveUtils } from '../../../../../utils/move-utils';
import { DefaultPiecesLoader } from '../../default-pieces-loader';
export class DefaultPgnProcessor {
    process(notation, engineFacade) {
        if (notation) {
            engineFacade.board.reverted = false;
            engineFacade.board.pieces = [];
            engineFacade.reset();
            DefaultPiecesLoader.loadDefaultPieces(engineFacade.board);
            let moves = this.extractMoves(notation);
            let counter = -1;
            for (let move of moves) {
                ++counter;
                move = move.replace(/[+#]/g, '');
                let promotionIndex = '';
                if (move.includes('=')) {
                    promotionIndex = this.resolvePromotion(move.substring(move.length - 1));
                    move = move.substring(0, move.length - 2);
                }
                let color = (counter === 0 || counter % 2 === 0)
                    ? Color.WHITE
                    : Color.BLACK;
                if (/^[a-z]\d$/g.test(move)) { // zwykly ruch na wolne pole e4
                    let piece = MoveUtils.findPieceByPossibleMovesContaining(move, engineFacade.board, color).find(piece => piece instanceof Pawn);
                    // en passant check
                    if (!piece) {
                        piece = MoveUtils.findPieceByPossibleCapturesContaining(move, engineFacade.board, color).find(piece => piece instanceof Pawn);
                    }
                    // if piece is found for sure
                    if (piece) {
                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move + promotionIndex);
                    }
                }
                else {
                    if (/^[A-Z][a-h]\d$/g.test(move)) { // jezeli ma wielka litere, czyli trzeba odszukac ktora figura Nf3
                        let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(1), engineFacade.board, color);
                        let piece = pieces.find(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
                        if (piece) {
                            engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(1) + promotionIndex);
                        }
                        else {
                        }
                    }
                    else {
                        if ('O-O' === move) {
                            engineFacade.move(color === Color.WHITE ? 'e1g1' : 'e8g8');
                        }
                        else {
                            if (/^[a-z]x[a-z]\d$/g.test(move)) { //exd5
                                let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter(piece => piece instanceof Pawn);
                                let piece;
                                if (pieces.length > 1) {
                                    piece = this.resolveByCol(pieces, move.substring(0, 1));
                                }
                                else {
                                    piece = pieces[0];
                                }
                                if (piece) {
                                    engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(move.indexOf('x') + 1) + promotionIndex);
                                }
                                else {
                                }
                            }
                            else {
                                if (/^[A-Z]x[a-z]\d$/g.test(move)) {
                                    let piece = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).find(piece => this.resolvePieceByFirstChar(move.substring(0, 1), piece));
                                    if (piece) {
                                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(move.indexOf('x') + 1) + promotionIndex);
                                    }
                                    else {
                                    }
                                }
                                else {
                                    if (move === 'O-O-O') {
                                        engineFacade.move(color === Color.WHITE ? 'e1c1' : 'e8c8');
                                    }
                                    else {
                                        if (/^[A-Z]\dx[a-z]\d$/g.test(move)) { //Ngxe4 sytuacja 2 skoczkow pion bicie
                                            let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                            let piece = this.resolveByRow(pieces, move.substring(1, 2));
                                            if (piece) {
                                                engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(move.indexOf('x') + 1) + promotionIndex);
                                            }
                                        }
                                        else {
                                            if (/^[A-Z][a-z][a-z]\d$/g.test(move)) { // dwie wieze bez bicia Rac1 pion
                                                let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(2, 4), engineFacade.board, color).filter(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                                let piece = this.resolveByCol(pieces, move.substring(1, 2));
                                                if (piece) {
                                                    engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(2, 4) + promotionIndex);
                                                }
                                            }
                                            else {
                                                if (/^[A-Z][a-z]x[a-z]\d$/g.test(move)) {
                                                    let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                                    let piece = this.resolveByCol(pieces, move.substring(1, 2));
                                                    if (piece) {
                                                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(move.indexOf('x') + 1) + promotionIndex);
                                                    }
                                                }
                                                else {
                                                    this.processR1f2(move, engineFacade, color, promotionIndex);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    processR1f2(move, engineFacade, color, promotionIndex) {
        if (/^[A-Z]\d[a-z]\d$/g.test(move)) { // R1f2
            let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(2, 4), engineFacade.board, color).filter(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
            let piece = this.resolveByRow(pieces, move.substring(1, 2));
            if (piece) {
                engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(2, 4) + promotionIndex);
            }
        }
    }
    extractMoves(notation) {
        return notation.substring(notation.lastIndexOf(']') + 1)
            .replace(/[0-9]+\./g, '')
            .replace(/\s+/g, ' ')
            .replace(/{[^}]*}/g, '')
            .trim()
            .split(' ')
            .filter(s => s);
    }
    movePiece(piece, board, move) {
        let indexes = MoveUtils.translateCoordsToIndex(move, board.reverted);
        piece.point.col = indexes.xAxis;
        piece.point.row = indexes.yAxis;
    }
    hasUpperCase(move) {
        return /[A-Z]/.test(move);
    }
    resolvePieceByFirstChar(move, piece) {
        let piecesFirstChar = '';
        if (piece instanceof King) {
            piecesFirstChar = 'K';
        }
        else {
            if (piece instanceof Queen) {
                piecesFirstChar = 'Q';
            }
            else {
                if (piece instanceof Rook) {
                    piecesFirstChar = 'R';
                }
                else {
                    if (piece instanceof Bishop) {
                        piecesFirstChar = 'B';
                    }
                    else {
                        if (piece instanceof Knight) {
                            piecesFirstChar = 'N';
                        }
                        else {
                            if (piece instanceof Pawn) {
                                piecesFirstChar = 'P';
                            }
                        }
                    }
                }
            }
        }
        return move === piecesFirstChar;
    }
    isShortCastle(move) {
        return move === 'O-O';
    }
    removePiece(coords, board) {
        let indexes = MoveUtils.translateCoordsToIndex(coords, board.reverted);
        board.pieces = board.pieces.filter(e => !e.point.isEqual(new Point(indexes.yAxis, indexes.xAxis)));
    }
    isLongCastle(move) {
        return move === 'O-O-O';
    }
    resolveByCol(pieces, char) {
        let firstPieceFormat = MoveUtils.formatSingle(pieces[0].point, false);
        let secondPieceFormat = MoveUtils.formatSingle(pieces[1].point, false);
        return firstPieceFormat.substring(0, 1) === char
            ? pieces[0]
            : pieces[1];
    }
    resolveByRow(pieces, char) {
        let firstPieceFormat = MoveUtils.formatSingle(pieces[0].point, false);
        let secondPieceFormat = MoveUtils.formatSingle(pieces[1].point, false);
        return firstPieceFormat.substring(1, 2) === char
            ? pieces[0]
            : pieces[1];
    }
    replacePromotion(move) {
        return move
            .replace('=Q', '1')
            .replace('=R', '2')
            .replace('=B', '3')
            .replace('=K', '4');
    }
    resolvePromotion(promotionChar) {
        switch (promotionChar) {
            case 'Q':
                return '1';
            case 'R':
                return '2';
            case 'B':
                return '3';
            case 'N':
                return '4';
        }
        return '';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1wZ24tcHJvY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWNoZXNzLWJvYXJkL3NyYy9saWIvZW5naW5lL2JvYXJkLXN0YXRlLXByb3ZpZGVyL2JvYXJkLWxvYWRlci9ub3RhdGlvbi1wcm9jZXNzb3JzL3Bnbi1sb2FkZXIvZGVmYXVsdC1wZ24tcHJvY2Vzc29yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDM0QsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3pELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFFekQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQzNELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUMzRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDekQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBRTVELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBR2xFLE1BQU0sT0FBTyxtQkFBbUI7SUFFckIsT0FBTyxDQUFDLFFBQWdCLEVBQUUsWUFBa0M7UUFDL0QsSUFBSSxRQUFRLEVBQUU7WUFDVixZQUFZLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7WUFDcEMsWUFBWSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO1lBQy9CLFlBQVksQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNyQixtQkFBbUIs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QUM1QyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNYLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEIsQ0FBQztJQUVPLGdCQUFnQixDQUFDLElBQVk7UUFDakMsT0FBTyxJQUFJO2FBQ04sT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUM7YUFDbEIsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUM7YUFDbEIsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUM7YUFDbEIsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBRU8sZ0JBQWdCLENBQUMsYUFBcUI7UUFDMUMsUUFBUSxhQUFhLEVBQUU7WUFDbkIsS0FBSyxHQUFHO2dCQUNKLE9BQU8sR0FBRyxDQUFDO1lBQ2YsS0FBSyxHQUFHO2dCQUNKLE9BQU8sR0FBRyxDQUFDO1lBQ2YsS0FBSyxHQUFHO2dCQUNKLE9BQU8sR0FBRyxDQUFDO1lBQ2YsS0FBSyxHQUFHO2dCQUNKLE9BQU8sR0FBRyxDQUFDO1NBQ2xCO1FBQ0QsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCb2FyZCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9ib2FyZCc7XG5pbXBvcnQgeyBCaXNob3AgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL2Jpc2hvcCc7XG5pbXBvcnQgeyBDb2xvciB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMvY29sb3InO1xuaW1wb3J0IHsgS2luZyB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMva2luZyc7XG5pbXBvcnQgeyBLbmlnaHQgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL2tuaWdodCc7XG5pbXBvcnQgeyBQYXduIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL3BpZWNlcy9wYXduJztcbmltcG9ydCB7IFBpZWNlIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL3BpZWNlcy9waWVjZSc7XG5pbXBvcnQgeyBQb2ludCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMvcG9pbnQnO1xuaW1wb3J0IHsgUXVlZW4gfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL3F1ZWVuJztcbmltcG9ydCB7IFJvb2sgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL3Jvb2snO1xuaW1wb3J0IHsgTW92ZVV0aWxzIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vdXRpbHMvbW92ZS11dGlscyc7XG5pbXBvcnQgeyBBYnN0cmFjdEVuZ2luZUZhY2FkZSB9IGZyb20gJy4uLy4uLy4uLy4uL2Fic3RyYWN0LWVuZ2luZS1mYWNhZGUnO1xuaW1wb3J0IHsgRGVmYXVsdFBpZWNlc0xvYWRlciB9IGZyb20gJy4uLy4uL2RlZmF1bHQtcGllY2VzLWxvYWRlcic7XG5pbXBvcnQgeyBOb3RhdGlvblByb2Nlc3NvciB9IGZyb20gJy4uL25vdGF0aW9uLXByb2Nlc3Nvcic7XG5cbmV4cG9ydCBjbGFzcyBEZWZhdWx0UGduUHJvY2Vzc29yIGltcGxlbWVudHMgTm90YXRpb25Qcm9jZXNzb3Ige1xuXG4gICAgcHVibGljIHByb2Nlc3Mobm90YXRpb246IHN0cmluZywgZW5naW5lRmFjYWRlOiBBYnN0cmFjdEVuZ2luZUZhY2FkZSk6IHZvaWQge1xuICAgICAgICBpZiAobm90YXRpb24pIHtcbiAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZC5yZXZlcnRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgZW5naW5lRmFjYWRlLmJvYXJkLnBpZWNlcyA9IFtdO1xuICAgICAgICAgICAgZW5naW5lRmFjYWRlLnJlc2V0KCk7XG4gICAgICAgICAgICBEZWZhdWx0UGllY2VzTG9hZGVyLmxvYWREZWZhdWx0UGllY2VzKGVuZ2luZUZhY2FkZS5ib2FyZCk7XG4gICAgICAgICAgICBsZXQgbW92ZXMgPSB0aGlzLmV4dHJhY3RNb3Zlcyhub3RhdGlvbik7XG4gICAgICAgICAgICBsZXQgY291bnRlciA9IC0xO1xuICAgICAgICAgICAgZm9yIChsZXQgbW92ZSBvZiBtb3Zlcykge1xuICAgICAgICAgICAgICAgICsrY291bnRlcjtcbiAgICAgICAgICAgICAgICBtb3ZlID0gbW92ZS5yZXBsYWNlKC9bKyNdL2csICcnKTtcbiAgICAgICAgICAgICAgICBsZXQgcHJvbW90aW9uSW5kZXggPSAnJztcblxuICAgICAgICAgICAgICAgIGlmIChtb3ZlLmluY2x1ZGVzKCc9JykpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvbW90aW9uSW5kZXggPSB0aGlzLnJlc29sdmVQcm9tb3Rpb24obW92ZS5zdWJzdHJpbmcobW92ZS5sZW5ndGggLSAxKSk7XG4gICAgICAgICAgICAgICAgICAgIG1vdmUgPSBtb3ZlLnN1YnN0cmluZygwLCBtb3ZlLmxlbmd0aCAtIDIpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxldCBjb2xvciA9IChjb3VudGVyID09PSAwIHx8IGNvdW50ZXIgJSAyID09PSAwKVxuICAgICAgICAgICAgICAgICAgICA/IENvbG9yLldISVRFXG4gICAgICAgICAgICAgICAgICAgIDogQ29sb3IuQkxBQ0s7XG5cbiAgICAgICAgICAgICAgICBpZiAoL15bYS16XVxcZCQvZy50ZXN0KG1vdmUpKSB7IC8vIHp3eWtseSBydWNoIG5hIHdvbG5lIHBvbGUgZTRcbiAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlID0gTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVNb3Zlc0NvbnRhaW5pbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLmJvYXJkLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JcbiAgICAgICAgICAgICAgICAgICAgKS5maW5kKHBpZWNlID0+IHBpZWNlIGluc3RhbmNlb2YgUGF3bik7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gZW4gcGFzc2FudCBjaGVja1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXBpZWNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwaWVjZSA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlQ2FwdHVyZXNDb250YWluaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUsIGVuZ2luZUZhY2FkZS5ib2FyZCwgY29sb3JcbiAgICAgICAgICAgICAgICAgICAgICAgICkuZmluZChwaWVjZSA9PiBwaWVjZSBpbnN0YW5jZW9mIFBhd24pO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gaWYgcGllY2UgaXMgZm91bmQgZm9yIHN1cmVcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICApICsgbW92ZSArIHByb21vdGlvbkluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgvXltBLVpdW2EtaF1cXGQkL2cudGVzdChtb3ZlKSkgey8vIGplemVsaSBtYSB3aWVsa2EgbGl0ZXJlLCBjenlsaSB0cnplYmEgb2RzenVrYWMga3RvcmEgZmlndXJhIE5mM1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlcyA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlTW92ZXNDb250YWluaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDEpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZSA9IHBpZWNlcy5maW5kKHBpZWNlID0+IHRoaXMucmVzb2x2ZVBpZWNlQnlGaXJzdENoYXIoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5jaGFyQXQoMCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VcbiAgICAgICAgICAgICAgICAgICAgICAgICkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArIG1vdmUuc3Vic3RyaW5nKDEpICsgcHJvbW90aW9uSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgnTy1PJyA9PT0gbW92ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5tb3ZlKGNvbG9yID09PSBDb2xvci5XSElURSA/ICdlMWcxJyA6ICdlOGc4Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgvXlthLXpdeFthLXpdXFxkJC9nLnRlc3QobW92ZSkpIHsgLy9leGQ1XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZXMgPSBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZUNhcHR1cmVzQ29udGFpbmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKG1vdmUuaW5kZXhPZigneCcpICsgMSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLmZpbHRlcihwaWVjZSA9PiBwaWVjZSBpbnN0YW5jZW9mIFBhd24pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlcy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZSA9IHRoaXMucmVzb2x2ZUJ5Q29sKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygwLCAxKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlID0gcGllY2VzWzBdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgbW92ZS5zdWJzdHJpbmcobW92ZS5pbmRleE9mKCd4JykgKyAxKSArIHByb21vdGlvbkluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgvXltBLVpdeFthLXpdXFxkJC9nLnRlc3QobW92ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZSA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlQ2FwdHVyZXNDb250YWluaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKG1vdmUuaW5kZXhPZigneCcpICsgMSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLmJvYXJkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLmZpbmQocGllY2UgPT4gdGhpcy5yZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygwLCAxKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgbW92ZS5zdWJzdHJpbmcobW92ZS5pbmRleE9mKCd4JykgKyAxKSArIHByb21vdGlvbkluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobW92ZSA9PT0gJ08tTy1PJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5tb3ZlKGNvbG9yID09PSBDb2xvci5XSElURSA/ICdlMWMxJyA6ICdlOGM4Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgvXltBLVpdXFxkeFthLXpdXFxkJC9nLnRlc3QobW92ZSkpIHsgIC8vTmd4ZTQgc3l0dWFjamEgMiBza29jemtvdyBwaW9uIGJpY2llXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZXMgPSBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZUNhcHR1cmVzQ29udGFpbmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKG1vdmUuaW5kZXhPZigneCcpICsgMSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLmZpbHRlcihwaWVjZSA9PiB0aGlzLnJlc29sdmVQaWVjZUJ5Rmlyc3RDaGFyKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5jaGFyQXQoMCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2UgPSB0aGlzLnJlc29sdmVCeVJvdyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDEsIDIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgbW92ZS5zdWJzdHJpbmcobW92ZS5pbmRleE9mKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd4JykgKyAxKSArIHByb21vdGlvbkluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgvXltBLVpdW2Etel1bYS16XVxcZCQvZy50ZXN0KG1vdmUpKSB7IC8vIGR3aWUgd2llemUgYmV6IGJpY2lhIFJhYzEgcGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlcyA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlTW92ZXNDb250YWluaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDIsIDQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5maWx0ZXIocGllY2UgPT4gdGhpcy5yZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLmNoYXJBdCgwKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZSA9IHRoaXMucmVzb2x2ZUJ5Q29sKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygxLCAyKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArIG1vdmUuc3Vic3RyaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArIHByb21vdGlvbkluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgvXltBLVpdW2Etel14W2Etel1cXGQkL2cudGVzdChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZXMgPSBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZUNhcHR1cmVzQ29udGFpbmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcobW92ZS5pbmRleE9mKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3gnKSArIDEpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5maWx0ZXIocGllY2UgPT4gdGhpcy5yZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5jaGFyQXQoMCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2UgPSB0aGlzLnJlc29sdmVCeUNvbChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygxLCAyKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgbW92ZS5zdWJzdHJpbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLmluZGV4T2YoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3gnKSArIDEpICsgcHJvbW90aW9uSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzUjFmMihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbW90aW9uSW5kZXhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwcm9jZXNzUjFmMihtb3ZlLCBlbmdpbmVGYWNhZGUsIGNvbG9yLCBwcm9tb3Rpb25JbmRleCkge1xuICAgICAgICBpZiAoL15bQS1aXVxcZFthLXpdXFxkJC9nLnRlc3QobW92ZSkpIHsgLy8gUjFmMlxuICAgICAgICAgICAgbGV0IHBpZWNlcyA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlTW92ZXNDb250YWluaW5nKFxuICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDIsIDQpLFxuICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcbiAgICAgICAgICAgICAgICBjb2xvclxuICAgICAgICAgICAgKS5maWx0ZXIocGllY2UgPT4gdGhpcy5yZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihcbiAgICAgICAgICAgICAgICBtb3ZlLmNoYXJBdCgwKSxcbiAgICAgICAgICAgICAgICBwaWVjZVxuICAgICAgICAgICAgKSk7XG5cbiAgICAgICAgICAgIGxldCBwaWVjZSA9IHRoaXMucmVzb2x2ZUJ5Um93KFxuICAgICAgICAgICAgICAgIHBpZWNlcyxcbiAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygxLCAyKVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgaWYgKHBpZWNlKSB7XG4gICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcbiAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQsXG4gICAgICAgICAgICAgICAgICAgIGZhbHNlXG4gICAgICAgICAgICAgICAgKSArIG1vdmUuc3Vic3RyaW5nKFxuICAgICAgICAgICAgICAgICAgICAyLFxuICAgICAgICAgICAgICAgICAgICA0XG4gICAgICAgICAgICAgICAgKSArIHByb21vdGlvbkluZGV4KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBleHRyYWN0TW92ZXMobm90YXRpb246IHN0cmluZykge1xuICAgICAgICByZXR1cm4gbm90YXRpb24uc3Vic3RyaW5nKG5vdGF0aW9uLmxhc3RJbmRleE9mKCddJykgKyAxKVxuICAgICAgICAgICAgLnJlcGxhY2UoL1swLTldK1xcLi9nLCAnJylcbiAgICAgICAgICAgIC5yZXBsYWNlKC9cXHMrL2csICcgJylcbiAgICAgICAgICAgIC5yZXBsYWNlKC97W159XSp9L2csICcnKVxuICAgICAgICAgICAgLnRyaW0oKVxuICAgICAgICAgICAgLnNwbGl0KCcgJylcbiAgICAgICAgICAgIC5maWx0ZXIocyA9PiBzKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgbW92ZVBpZWNlKHBpZWNlOiBQaWVjZSwgYm9hcmQ6IEJvYXJkLCBtb3ZlOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IGluZGV4ZXMgPSBNb3ZlVXRpbHMudHJhbnNsYXRlQ29vcmRzVG9JbmRleChtb3ZlLCBib2FyZC5yZXZlcnRlZCk7XG4gICAgICAgIHBpZWNlLnBvaW50LmNvbCA9IGluZGV4ZXMueEF4aXM7XG4gICAgICAgIHBpZWNlLnBvaW50LnJvdyA9IGluZGV4ZXMueUF4aXM7XG4gICAgfVxuXG4gICAgaGFzVXBwZXJDYXNlKG1vdmU6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gL1tBLVpdLy50ZXN0KG1vdmUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVzb2x2ZVBpZWNlQnlGaXJzdENoYXIobW92ZTogc3RyaW5nLCBwaWVjZTogUGllY2UpIHtcbiAgICAgICAgbGV0IHBpZWNlc0ZpcnN0Q2hhciA9ICcnO1xuICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBLaW5nKSB7XG4gICAgICAgICAgICBwaWVjZXNGaXJzdENoYXIgPSAnSyc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBRdWVlbikge1xuICAgICAgICAgICAgICAgIHBpZWNlc0ZpcnN0Q2hhciA9ICdRJztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgUm9vaykge1xuICAgICAgICAgICAgICAgICAgICBwaWVjZXNGaXJzdENoYXIgPSAnUic7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgQmlzaG9wKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwaWVjZXNGaXJzdENoYXIgPSAnQic7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBLbmlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZXNGaXJzdENoYXIgPSAnTic7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIFBhd24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzRmlyc3RDaGFyID0gJ1AnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbW92ZSA9PT0gcGllY2VzRmlyc3RDaGFyO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNTaG9ydENhc3RsZShtb3ZlOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIG1vdmUgPT09ICdPLU8nO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVtb3ZlUGllY2UoY29vcmRzOiBzdHJpbmcsIGJvYXJkOiBCb2FyZCkge1xuICAgICAgICBsZXQgaW5kZXhlcyA9IE1vdmVVdGlscy50cmFuc2xhdGVDb29yZHNUb0luZGV4KGNvb3JkcywgYm9hcmQucmV2ZXJ0ZWQpO1xuXG4gICAgICAgIGJvYXJkLnBpZWNlcyA9IGJvYXJkLnBpZWNlcy5maWx0ZXIoZSA9PiAhZS5wb2ludC5pc0VxdWFsKG5ldyBQb2ludChcbiAgICAgICAgICAgIGluZGV4ZXMueUF4aXMsXG4gICAgICAgICAgICBpbmRleGVzLnhBeGlzXG4gICAgICAgICkpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzTG9uZ0Nhc3RsZShtb3ZlOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIG1vdmUgPT09ICdPLU8tTyc7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZXNvbHZlQnlDb2wocGllY2VzOiBQaWVjZVtdLCBjaGFyOiBzdHJpbmcpOiBQaWVjZSB7XG4gICAgICAgIGxldCBmaXJzdFBpZWNlRm9ybWF0ID0gTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShwaWVjZXNbMF0ucG9pbnQsIGZhbHNlKTtcbiAgICAgICAgbGV0IHNlY29uZFBpZWNlRm9ybWF0ID0gTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShwaWVjZXNbMV0ucG9pbnQsIGZhbHNlKTtcbiAgICAgICAgcmV0dXJuIGZpcnN0UGllY2VGb3JtYXQuc3Vic3RyaW5nKDAsIDEpID09PSBjaGFyXG4gICAgICAgICAgICA/IHBpZWNlc1swXVxuICAgICAgICAgICAgOiBwaWVjZXNbMV07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZXNvbHZlQnlSb3cocGllY2VzOiBQaWVjZVtdLCBjaGFyOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IGZpcnN0UGllY2VGb3JtYXQgPSBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKHBpZWNlc1swXS5wb2ludCwgZmFsc2UpO1xuICAgICAgICBsZXQgc2Vjb25kUGllY2VGb3JtYXQgPSBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKHBpZWNlc1sxXS5wb2ludCwgZmFsc2UpO1xuICAgICAgICByZXR1cm4gZmlyc3RQaWVjZUZvcm1hdC5zdWJzdHJpbmcoMSwgMikgPT09IGNoYXJcbiAgICAgICAgICAgID8gcGllY2VzWzBdXG4gICAgICAgICAgICA6IHBpZWNlc1sxXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlcGxhY2VQcm9tb3Rpb24obW92ZTogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBtb3ZlXG4gICAgICAgICAgICAucmVwbGFjZSgnPVEnLCAnMScpXG4gICAgICAgICAgICAucmVwbGFjZSgnPVInLCAnMicpXG4gICAgICAgICAgICAucmVwbGFjZSgnPUInLCAnMycpXG4gICAgICAgICAgICAucmVwbGFjZSgnPUsnLCAnNCcpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVzb2x2ZVByb21vdGlvbihwcm9tb3Rpb25DaGFyOiBzdHJpbmcpIHtcbiAgICAgICAgc3dpdGNoIChwcm9tb3Rpb25DaGFyKSB7XG4gICAgICAgICAgICBjYXNlICdRJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gJzEnO1xuICAgICAgICAgICAgY2FzZSAnUic6XG4gICAgICAgICAgICAgICAgcmV0dXJuICcyJztcbiAgICAgICAgICAgIGNhc2UgJ0InOlxuICAgICAgICAgICAgICAgIHJldHVybiAnMyc7XG4gICAgICAgICAgICBjYXNlICdOJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gJzQnO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAnJztcbiAgICB9XG59XG4iXX0=