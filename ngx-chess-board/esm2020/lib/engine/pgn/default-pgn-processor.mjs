import { King } from '../../models/pieces/king';
import { Pawn } from '../../models/pieces/pawn';
import { MoveUtils } from '../../utils/move-utils';
import { AbstractPgnProcessor } from './abstract-pgn-processor';
export class DefaultPgnProcessor extends AbstractPgnProcessor {
    process(board, sourcePiece, destPoint, destPiece) {
        this.currentIndex += 0.5;
        let currentMove = '';
        if (this.currentIndex % Math.floor(this.currentIndex) === 0) {
            currentMove = this.currentIndex + '.';
        }
        let possibleCaptures = [];
        let possibleMoves = [];
        if (destPiece) {
            possibleCaptures = MoveUtils.findPieceByPossibleCapturesContaining(MoveUtils.formatSingle(destPoint, board.reverted), board, sourcePiece.color).filter(piece => piece.constructor.name === sourcePiece.constructor.name);
        }
        possibleMoves = MoveUtils.findPieceByPossibleMovesContaining(MoveUtils.formatSingle(destPoint, board.reverted), board, sourcePiece.color).filter(piece => piece.constructor.name === sourcePiece.constructor.name);
        if (sourcePiece instanceof Pawn && !destPiece && possibleCaptures.length === 0) {
            currentMove += MoveUtils.formatSingle(destPoint, board.reverted);
        }
        else {
            if (sourcePiece instanceof Pawn && destPiece) {
                currentMove += (MoveUtils.formatSingle(sourcePiece.point, board.reverted).substring(0, 1) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted));
            }
            else {
                if (sourcePiece instanceof King && (Math.abs(sourcePiece.point.col - destPoint.col) === 2)) {
                    if (board.reverted) {
                        currentMove += (destPoint.col < 2
                            ? 'O-O'
                            : 'O-O-O');
                    }
                    else {
                        currentMove += destPoint.col < 3
                            ? 'O-O-O'
                            : 'O-O';
                    }
                }
                else {
                    if (!(sourcePiece instanceof Pawn) && possibleCaptures.length === 0 && possibleMoves.length < 2) { // Nf3
                        currentMove += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatSingle(destPoint, board.reverted);
                    }
                    else {
                        if (possibleMoves && possibleMoves.length === 2 && possibleCaptures.length === 0) { // Nbd7
                            if (this.isEqualByCol(possibleMoves[0], possibleMoves[1])) {
                                currentMove += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.reverse(board, sourcePiece.point.row) + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                            else {
                                currentMove += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatCol(board, sourcePiece.point.col) + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                        }
                        else {
                            if (possibleCaptures.length > 1) {
                                if ((this.isEqualByCol(possibleCaptures[0], possibleCaptures[1]))) {
                                    currentMove += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.reverse(board, sourcePiece.point.row) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                                }
                                else {
                                    currentMove += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatCol(board, sourcePiece.point.col) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                                }
                            }
                            else {
                                currentMove += MoveUtils.getFirstLetterPiece(sourcePiece) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                        }
                    }
                }
            }
        }
        this.pgn.push(currentMove);
    }
    resolvePieceByFirstChar(move, piece) {
        return MoveUtils.getFirstLetterPiece(piece) === move;
    }
    isEqualByCol(aPiece, bPiece) {
        return aPiece.point.col === bPiece.point.col;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1wZ24tcHJvY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWNoZXNzLWJvYXJkL3NyYy9saWIvZW5naW5lL3Bnbi9kZWZhdWx0LXBnbi1wcm9jZXNzb3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUdoRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDbkQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFaEUsTUFBTSxPQUFPLG1CQUFvQixTQUFRLG9CQUFvQjtJQUVsRCxPQUFPLENBQ1YsS0FBWSxFQUNaLFdBQWtCLEVBQ2xCLFNBQWdCLEVBQ2hCLFNBQWlCO1FBRWpCLElBQUksQ0FBQyxZQUFZLElBQUksR0FBRyxDQUFDO1FBQ3pCLElBQUksV0FBVyxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFHLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3hELFdBQVcsR0FBRyxJQUFJLENBQUMsWUFBWSxHQUFHLEdBQUcsQ0FBQztTQUN6QztRQUNELElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBQzFCLElBQUksYUFBYSxHQUFHLEVBQUUsQ0FBQztRQUV2QixJQUFJLFNBQVMsRUFBRTtZQUNYLGdCQUFnQixHQUFHLFNBQVMsQ0FBQyxxQ0FBcUMsQ0FDOUQsU0FBUyxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUNqRCxLQUFLLEVBQ0wsV0FBVyxDQUFDLEtBQUssQ0FDcEIsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FB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LE9BQU8sU0FBUyxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksQ0FBQztJQUN6RCxDQUFDO0lBRU8sWUFBWSxDQUFDLE1BQWEsRUFBRSxNQUFhO1FBQzdDLE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEtBQUssTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7SUFDakQsQ0FBQztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQm9hcmQgfSBmcm9tICcuLi8uLi9tb2RlbHMvYm9hcmQnO1xuaW1wb3J0IHsgS2luZyB9IGZyb20gJy4uLy4uL21vZGVscy9waWVjZXMva2luZyc7XG5pbXBvcnQgeyBQYXduIH0gZnJvbSAnLi4vLi4vbW9kZWxzL3BpZWNlcy9wYXduJztcbmltcG9ydCB7IFBpZWNlIH0gZnJvbSAnLi4vLi4vbW9kZWxzL3BpZWNlcy9waWVjZSc7XG5pbXBvcnQgeyBQb2ludCB9IGZyb20gJy4uLy4uL21vZGVscy9waWVjZXMvcG9pbnQnO1xuaW1wb3J0IHsgTW92ZVV0aWxzIH0gZnJvbSAnLi4vLi4vdXRpbHMvbW92ZS11dGlscyc7XG5pbXBvcnQgeyBBYnN0cmFjdFBnblByb2Nlc3NvciB9IGZyb20gJy4vYWJzdHJhY3QtcGduLXByb2Nlc3Nvcic7XG5cbmV4cG9ydCBjbGFzcyBEZWZhdWx0UGduUHJvY2Vzc29yIGV4dGVuZHMgQWJzdHJhY3RQZ25Qcm9jZXNzb3Ige1xuXG4gICAgcHVibGljIHByb2Nlc3MoXG4gICAgICAgIGJvYXJkOiBCb2FyZCxcbiAgICAgICAgc291cmNlUGllY2U6IFBpZWNlLFxuICAgICAgICBkZXN0UG9pbnQ6IFBvaW50LFxuICAgICAgICBkZXN0UGllY2U/OiBQaWVjZVxuICAgICk6IHZvaWQge1xuICAgICAgICB0aGlzLmN1cnJlbnRJbmRleCArPSAwLjU7XG4gICAgICAgIGxldCBjdXJyZW50TW92ZSA9ICcnO1xuICAgICAgICBpZih0aGlzLmN1cnJlbnRJbmRleCAlIE1hdGguZmxvb3IodGhpcy5jdXJyZW50SW5kZXgpID09PSAwKSB7XG4gICAgICAgICAgICBjdXJyZW50TW92ZSA9IHRoaXMuY3VycmVudEluZGV4ICsgJy4nO1xuICAgICAgICB9XG4gICAgICAgIGxldCBwb3NzaWJsZUNhcHR1cmVzID0gW107XG4gICAgICAgIGxldCBwb3NzaWJsZU1vdmVzID0gW107XG5cbiAgICAgICAgaWYgKGRlc3RQaWVjZSkge1xuICAgICAgICAgICAgcG9zc2libGVDYXB0dXJlcyA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlQ2FwdHVyZXNDb250YWluaW5nKFxuICAgICAgICAgICAgICAgIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoZGVzdFBvaW50LCBib2FyZC5yZXZlcnRlZCksXG4gICAgICAgICAgICAgICAgYm9hcmQsXG4gICAgICAgICAgICAgICAgc291cmNlUGllY2UuY29sb3JcbiAgICAgICAgICAgICkuZmlsdGVyKHBpZWNlID0+IHBpZWNlLmNvbnN0cnVjdG9yLm5hbWUgPT09IHNvdXJjZVBpZWNlLmNvbnN0cnVjdG9yLm5hbWUpO1xuICAgICAgICB9XG4gICAgICAgIHBvc3NpYmxlTW92ZXMgPSBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZU1vdmVzQ29udGFpbmluZyhcbiAgICAgICAgICAgIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoZGVzdFBvaW50LCBib2FyZC5yZXZlcnRlZCksXG4gICAgICAgICAgICBib2FyZCxcbiAgICAgICAgICAgIHNvdXJjZVBpZWNlLmNvbG9yXG4gICAgICAgICkuZmlsdGVyKHBpZWNlID0+IHBpZWNlLmNvbnN0cnVjdG9yLm5hbWUgPT09IHNvdXJjZVBpZWNlLmNvbnN0cnVjdG9yLm5hbWUpO1xuXG4gICAgICAgIGlmIChzb3VyY2VQaWVjZSBpbnN0YW5jZW9mIFBhd24gJiYgIWRlc3RQaWVjZSAmJiBwb3NzaWJsZUNhcHR1cmVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgY3VycmVudE1vdmUgKz0gTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShkZXN0UG9pbnQsIGJvYXJkLnJldmVydGVkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChzb3VyY2VQaWVjZSBpbnN0YW5jZW9mIFBhd24gJiYgZGVzdFBpZWNlKSB7XG4gICAgICAgICAgICAgICAgY3VycmVudE1vdmUgKz0gKE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlLnBvaW50LFxuICAgICAgICAgICAgICAgICAgICBib2FyZC5yZXZlcnRlZFxuICAgICAgICAgICAgICAgICkuc3Vic3RyaW5nKDAsIDEpICsgJ3gnICsgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcbiAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LFxuICAgICAgICAgICAgICAgICAgICBib2FyZC5yZXZlcnRlZFxuICAgICAgICAgICAgICAgICkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoc291cmNlUGllY2UgaW5zdGFuY2VvZiBLaW5nICYmIChNYXRoLmFicyhzb3VyY2VQaWVjZS5wb2ludC5jb2wgLSBkZXN0UG9pbnQuY29sKSA9PT0gMikpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJvYXJkLnJldmVydGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50TW92ZSArPSAoZGVzdFBvaW50LmNvbCA8IDJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdPLU8nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnTy1PLU8nKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRNb3ZlICs9IGRlc3RQb2ludC5jb2wgPCAzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAnTy1PLU8nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnTy1PJztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghKHNvdXJjZVBpZWNlIGluc3RhbmNlb2YgUGF3bikgJiYgcG9zc2libGVDYXB0dXJlcy5sZW5ndGggPT09IDAgJiYgcG9zc2libGVNb3Zlcy5sZW5ndGggPCAyKSB7ICAgICAvLyBOZjNcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRNb3ZlICs9IE1vdmVVdGlscy5nZXRGaXJzdExldHRlclBpZWNlKHNvdXJjZVBpZWNlKSArIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlTW92ZXMgJiYgcG9zc2libGVNb3Zlcy5sZW5ndGggPT09IDIgJiYgcG9zc2libGVDYXB0dXJlcy5sZW5ndGggPT09IDApIHsgICAgLy8gTmJkN1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRXF1YWxCeUNvbChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zc2libGVNb3Zlc1swXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zc2libGVNb3Zlc1sxXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE1vdmUgKz0gIE1vdmVVdGlscy5nZXRGaXJzdExldHRlclBpZWNlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UpICsgTW92ZVV0aWxzLnJldmVyc2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2FyZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlLnBvaW50LnJvd1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RQb2ludCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE1vdmUgKz0gTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VQaWVjZSkgKyBNb3ZlVXRpbHMuZm9ybWF0Q29sKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VQaWVjZS5wb2ludC5jb2xcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0UG9pbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2FyZC5yZXZlcnRlZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlQ2FwdHVyZXMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHRoaXMuaXNFcXVhbEJ5Q29sKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zc2libGVDYXB0dXJlc1swXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3NpYmxlQ2FwdHVyZXNbMV1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRNb3ZlICs9IE1vdmVVdGlscy5nZXRGaXJzdExldHRlclBpZWNlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlKSArIE1vdmVVdGlscy5yZXZlcnNlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlLnBvaW50LnJvd1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArICd4JyArIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE1vdmUgKz0gTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UpICsgTW92ZVV0aWxzLmZvcm1hdENvbChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2FyZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VQaWVjZS5wb2ludC5jb2xcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgKyAneCcgKyBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RQb2ludCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2FyZC5yZXZlcnRlZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRNb3ZlICs9IE1vdmVVdGlscy5nZXRGaXJzdExldHRlclBpZWNlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UpICsgJ3gnICsgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RQb2ludCwgYm9hcmQucmV2ZXJ0ZWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wZ24ucHVzaChjdXJyZW50TW92ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihtb3ZlOiBzdHJpbmcsIHBpZWNlOiBQaWVjZSkge1xuICAgICAgICByZXR1cm4gTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2UocGllY2UpID09PSBtb3ZlO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNFcXVhbEJ5Q29sKGFQaWVjZTogUGllY2UsIGJQaWVjZTogUGllY2UpIHtcbiAgICAgICAgcmV0dXJuIGFQaWVjZS5wb2ludC5jb2wgPT09IGJQaWVjZS5wb2ludC5jb2w7XG4gICAgfVxuXG59XG4iXX0=